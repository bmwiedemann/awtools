#!/usr/bin/perl -w

use strict;
use CGI ":standard";

my %options;

sub spinfo($) { my($id)=@_; # short player info string
	if($id==2) {return "unknown"}
	if($id==0) {return "free planet"}
	my $name=$::player{$id}{name};
	my $aid=$::player{$id}{alliance};
	my @rel=getrelation($name);
	my $color=getrelationcolor($rel[0]);
	my $alliancestr="";
	if(!$rel[1] && $aid>0) { $rel[1]=$::alliances{$aid}{tag} }
	if($rel[1]) { $alliancestr="[".$rel[1]."]"; }
	return span({-style=>'color: '.$color}, qq!$alliancestr $name ($id) <a href="relations?name=$name"><img src="/images/aw/relations-16.png" alt="relation"></a> !.profilelink($id));
}

print header;
print start_html('AW system info');
my $path="/home/bernhard/code/cvs/perl/awcalc";
chdir $path;

if(param("legend")) {
	require "input.pm";
	print "legend: ";
	for my $n (1..9) {
		my $color=getrelationcolor($n);
		print span({-style=>'color: '.$color}, br."$n $color = $::relationname{$n}\n");
	}
	print end_html;
	exit 0;
}

if(param()) {
	my($x,$y,$system);
	for my $p (qw'x y mapx mapy id name') {
	  $options{$p}=param($p);
	}
	require "awmap.pm";
	require "input.pm";
	if(defined($options{mapx})) { ($x,$y)=($options{mapx}, $options{mapy}) }
	elsif(defined($options{x})) { ($x,$y)=imgtomap($options{x}, $options{y}) }
	if(defined($x)) { $system=$::starmap{"$x,$y"}; }
	if(!$system && $options{name}) { $system=$::starmap{"\L$options{name}"} }
	if(!$system && $options{id}) { $system=$options{id} }
	if(!$system) {
		print "no system $options{name} at $x,$y";
	} else {
		($x,$y)=($::starmap{$system}{x},$::starmap{$system}{y});
		print qq!<a href="?legend=1">legend</a>!,br;
		print "<b>$::starmap{$system}{name}($x,$y)</b><br>Id=$system level=$::starmap{$system}{level}",qq! <a href="http://www1.astrowars.com/about/starmap.php?dx=$x&dy=$y">starmap</a> <a href="http://www1.astrowars.com/0/Map/Detail.php/?nr=$system">map/details</a>!,br;
		print "planets here: <ul>";
		my $planets=$::planets{$system};
		foreach my $h (@$planets) {
			print li;
			next if(!$h);
#			foreach my $item (sort keys %$h) { print " $item=$$h{$item}\n"; }
			my $id="$system#$$h{planetid}";
			my $pinfo=$::planetinfo{$id};
			$id=~s/#/%23/;
			my $info="";
			if($pinfo) {
				$pinfo=~/^(\d) (\d+) (.*)/;
				my $status=$1;
				$pinfo=$3;
				my $name=playerid2name($2);
				$info=$::planetstatusstring{$status}." ".span({-style=>'color: '.getstatuscolor($status)},$name.": ".$pinfo);
			}
			print "#$$h{planetid} pop $$h{population} SB $$h{starbase} ", spinfo($$h{ownerid}), qq! <a href="planet-info?id=$id"><img src="/images/aw/edit-planet-28.png" alt="edit planet-info"></a> !, $info;
			
		}
		print "</ul>\n";
		print "players having their origin here: <ul>";
		foreach(@{$::starmap{$system}{origin}}) { print li,spinfo($_); }
		print "</ul>\n";
	}
} else { 
  print start_form('get'),
   textfield('mapx'), " x", br,
   textfield('mapy'), " y (e.g. x=0 y=0 for Rana)", br,
   "or",br,
   textfield('id'), " system id", br,
   "or",br,
   textfield('name'), " system name", br,
   submit, end_form;
}
print end_html;


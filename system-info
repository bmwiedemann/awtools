#!/usr/bin/perl

use strict;
use CGI ":standard";

my %options;

sub spinfo($) { my($id)=@_; # short player info string
	if($id==2) {return "unknown"}
	if($id==0) {return "free planet"}
	my $name=$::player{$id}{name};
	my $aid=$::player{$id}{alliance};
	my @rel=getrelation($name);
	my $color=getrelationcolor($rel[0]);
	my $alliancestr="";
	if(!$rel[1] && $aid>0) { $rel[1]=$::alliances{$aid}{tag} }
	if($rel[1]) { $alliancestr="[".$rel[1]."]"; }
	my $rellink=qq! <a href="relations?name=$name"><img src="/images/aw/relations-colored.gif" title="player info + relation"></a> !;
	if($options{export}) {
		return "[color=$color]$alliancestr $name [/color]";
	}
	return profilelink($id).$rellink.
		span({-style=>'color: '.$color}, qq!$alliancestr $name ($id) !);
}
sub tprint { unless($options{export}){print @_} }

my $path="/home/bernhard/code/cvs/perl/awcalc";
chdir $path;
for my $p (qw'x y') {
  $options{$p}=param($p);
}
if(defined($options{x}) && defined($options{y})) {
	require "awmap.pm";
	my($x,$y)=imgtomap($options{x}, $options{y});
	print redirect("http://$ENV{HTTP_HOST}$ENV{SCRIPT_NAME}?mapx=$x&mapy=$y");
	exit(0);
}
print header;

if(param("legend")) {
	print start_html('legend of AW relations');
	require "input.pm";
	print "legend: ";
	for my $n (1..9) {
		my $color=getrelationcolor($n);
		print span({-style=>'color: '.$color}, br."$n $color = $::relationname{$n}\n");
	}
	print end_html;
	exit 0;
}

if(param()) {
	my($x,$y,$system);
	for my $p (qw'x y mapx mapy id name export') {
	  $options{$p}=param($p);
	}
	require "awmap.pm";
	require "input.pm";
	if(defined($options{mapx})) { ($x,$y)=($options{mapx}, $options{mapy}) }
	elsif(defined($options{x})) { ($x,$y)=imgtomap($options{x}, $options{y}) }
	if(defined($x)) { $system=systemcoord2id($x,$y) }
	if(!$system && $options{name}) { $system=systemname2id($options{name}) }
	if(!$system && $options{id}) { $system=$options{id} }
	if(!$system) {
		print start_html('system not found');
		print "no system $options{name} at $x,$y";
	} else {
		($x,$y)=($::starmap{$system}{x},$::starmap{$system}{y});
		print start_html("($x,$y) $::starmap{$system}{name} system info [\U$ENV{REMOTE_USER}\E]");
		my ($bs,$be,$eol)=('[b]','[/b]',"\n");

		## start of normal output ##
		if(!$options{export}) {
			print qq!<a href="?legend=1">legend</a> <a href="?">new query</a> <a href="?id=$system&export=1">BB-export</a>!,br;
			($bs,$be,$eol)=('<b>','</b>',"<br>\n");
		}
		my $output="$bs$::starmap{$system}{name}($x,$y)$be${eol}Id=$system level=$::starmap{$system}{level}$eol";
		if(!$options{export}) {
			my @systeminfo=getplanetinfo($system,0);
			my $sysinfo=$systeminfo[2]||"";
			tprint $output, qq! <a href="tactical-large?xs=$x&ys=$y&xe=29&ye=19">tactical</a> <a href="http://www1.astrowars.com/about/starmap.php?dx=$x&dy=$y">starmap</a> <a href="http://www1.astrowars.com/0/Map/Detail.php/?nr=$system">map/details</a>!,br,$sysinfo,
			"planets here: <ul>";
		}
		my $planets=$::planets{$system};
		foreach my $h (@$planets) {
			tprint li;
			next if(!$h);
#			foreach my $item (sort keys %$h) { print " $item=$$h{$item}\n"; }
			my $id="$system#$$h{planetid}";
			my $pinfo;
			my @pinfo=getplanetinfo($system,$$h{planetid});
			$id=~s/#/%23/;
			my $info="";
			if(@pinfo) {
				my $status=$pinfo[0];
				my $name=playerid2name($pinfo[1]);
				$pinfo=$pinfo[2];
				my @rel=getrelation($name);
				my $scolor=getstatuscolor($status);
				my $rcolor=getrelationcolor($rel[0]);
				my $atag=getatag($rel[1]);
				if($options{export}) {
					$info=qq![color=$scolor]$::planetstatusstring{$status} [/color] [color=$rcolor]$atag $name [/color]: $pinfo!;
				} else {
					$info=" ".span({-style=>"color: $scolor"},$::planetstatusstring{$status})." ".span({-style=>"color: $rcolor"},$atag." ".$name).": ".$pinfo;
				}
			}
			my $plink=qq! <a href="planet-info?id=$id"><img src="/images/aw/edit-planet.gif" title="edit planet-info"></a> !;
			my $siegedcol="";
			if(planet2siege($h)) { $siegedcol=qq!style="background-color: red"!; }
			if(!$options{export}) {
				printf "<span $siegedcol><code>#%2i pop=%2i SB=%2i</code></span> %s%s%s", $$h{planetid}, planet2pop($h), planet2sb($h), $plink, spinfo($$h{ownerid}), $info;
			} else {
				$output.=sprintf("$eol#%2i pop=%2i SB=%2i %s %s", $$h{planetid}, planet2pop($h), planet2sb($h), spinfo($$h{ownerid}), $info);
			}
			
		}
		if(!$options{export}) {
			print "</ul>\n";
			print "players having their origin here: <ul>";
			foreach(@{$::starmap{$system}{origin}}) { print li,spinfo($_); }
			print "</ul>\n";
		} else {
			print qq!<textarea cols=80 rows=15 name="dummy">$output</textarea>!;
		}
	}
} else { 
  print start_html("AW system info");
  print start_form('get'),
   textfield('mapx'), " x", br,
   textfield('mapy'), " y (e.g. x=0 y=0 for Rana)", br,
   "or",br,
   textfield('id'), " system id", br,
   "or",br,
   textfield('name'), " system name", br,
   submit, end_form;
}
print end_html;


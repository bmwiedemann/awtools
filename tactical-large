#!/usr/bin/perl
use strict;
use CGI ":standard";
alarm 30;

my $imgsize=2*13;
sub round($) {int($_[0]+0.5)}
if(!$ENV{REMOTE_USER}) {$ENV{REMOTE_USER}="af"}
my $title="large tactical map [\U$ENV{REMOTE_USER}\E]";
my %options;
chdir "/home/bernhard/code/cvs/perl/awcalc";
require "awmap.pm";
require "awmapcgi.pm";
#require "input.pm";
chdir "large-$ENV{REMOTE_USER}";
for my $p (qw'xs xe ys ye x y') {
	$options{$p}=param($p);
}
if(defined($options{x}) && defined($options{y})) {
	my $f="star$options{x},$options{y}.png";
	my $size=(stat($f))[7];
	my $modified=(stat($f))[9];
	print header(-type=>'image/png', -expires=>'+1d', -last_modified=>$modified, -content_lenth=>$size);
	undef($/);
	open(F,"< $f") or die $!;
	print <F>;
	exit(0);
}

my $style="/tactical-large.css";#qq%\nimg {border:0;}%; #body {margin-left:0px; margin-top:0px;}
if(defined($options{xs}) && !($options{xe}<0 || $options{ye}<0 || $options{xe}>100 || $options{ye}>100))
{
	print header(-expires=>'+1d'), start_html(-title=>$title, -style=>$style);
	my $xe=round($options{xs}+$options{xe}/2);
	my $ye=round($options{ys}+$options{ye}/2);
	my $xs=round($options{xs}-$options{xe}/2);
	my $ys=round($options{ys}-$options{ye}/2);
	print qq!<table border="0" cellspacing="0" cellpadding="0" bgcolor='#000000'>!;
	for(my $my=$ys; $my<$ye; $my++) {
		print "<tr>";
		for(my $mx=$xs; $mx<$xe; $mx++) {
#			print "<td> $mx,$my</td>"
			my $f="star$mx,$my.png";
			my $link="";
			my $linkend="</a>";
			if(! -e $f) {my $n=0;
				if($mx%10<=1) {$n|=2}
				if($my%10<=1) {$n|=1}
				if($mx%10==0||$my%10==0) {$n=3}
				$f="/$n.gif";
				$link=qq!<a href="?xs=$mx&ys=$my&xe=$options{xe}&ye=$options{ye}">!;
			} else {
				$f="?x=$mx&y=$my";
				$link=qq!<a href="system-info?mapx=$mx&mapy=$my">!;}
			my $formatstr="";
			if($my==$ys || $mx==$xs) {$formatstr=qq! height="$imgsize" width=$imgsize"!}
			print qq!<td>$link<img src="$f"$formatstr>$linkend</td>!;
		}
		print "</tr>\n";
	}
	print "</table>";
} else {
	print header(-expires=>'+1d'), AWheader2($title);
	my @pos=(0,0);
	my @s=(29,25);
	if($ENV{REMOTE_USER} eq "af") { @pos=(20,-51); }#$s[1]=37; }
	elsif($ENV{REMOTE_USER} eq "fun") { @pos=(20,-51); }
	elsif($ENV{REMOTE_USER} eq "tbgsaf") { @pos=(20,-54); }
	elsif($ENV{REMOTE_USER} eq "tgd") { @pos=(57,20); $s[1]+=10; }
	elsif($ENV{REMOTE_USER} eq "xr") { @pos=(-60,60) }
	elsif($ENV{REMOTE_USER} eq "la") { @pos=(26,30) }
	elsif($ENV{REMOTE_USER} eq "blub") { @pos=(57,39) }
        my $awuid=playername2id(cookie('user'));
        if($awuid>2) {
		my $home=playerid2home($awuid);
		@pos=systemid2coord($home);
	}
	print start_form('get'), 
	 awmapcoordinput(),
	 submit(-name=>"draw", -class=>'smbutton'), end_form();
}
print end_html;

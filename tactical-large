#!/usr/bin/perl
use strict;
use CGI ":standard";
alarm 30;

sub round($) {int($_[0]+0.5)}
if(!$ENV{REMOTE_USER}) {$ENV{REMOTE_USER}="af"}
my $title="\U$ENV{REMOTE_USER}\E new tactical map";
my %options;
chdir "/home/bernhard/code/cvs/perl/awcalc";
require "awmap.pm";
chdir "large-$ENV{REMOTE_USER}";
for my $p (qw'xs xe ys ye x y') {
	$options{$p}=param($p);
}
if(defined($options{x}) && defined($options{y})) {
	my $f="star$options{x},$options{y}.gif";
	my $size=(stat($f))[7];
	my $modified=(stat($f))[9];
	print header(-type=>'image/gif', -expires=>'+1d', -last_modified=>$modified, -content_lenth=>$size);
	undef($/);
	open(F,"< $f") or die $!;
	print <F>;
	exit(0);
}

my $style=qq%\nimg {border:0;}%; #body {margin-left:0px; margin-top:0px;}
print header(-expires=>'+1d'), start_html(-title=>$title, -style=>$style, -leftmargin=>0, -topmargin=>0);#, -bgcolor=>"#000000");
if(defined($options{xs}) && !($options{xe}<0 || $options{ye}<0 || $options{xe}>100 || $options{ye}>100))
{
	my $xe=round($options{xs}+$options{xe}/2);
	my $ye=round($options{ys}+$options{ye}/2);
	my $xs=round($options{xs}-$options{xe}/2);
	my $ys=round($options{ys}-$options{ye}/2);
	print qq!<table border="0" cellspacing="0" cellpadding="0" bgcolor='#000000'>!;
	for(my $my=$ys; $my<$ye; $my++) {
		print "<tr>";
		for(my $mx=$xs; $mx<$xe; $mx++) {
#			print "<td> $mx,$my</td>"
			my $f="star$mx,$my.gif";
			my $link="";
			my $linkend="</a>";
			if(! -e $f) {my $n=0;
				if($mx%10<=1) {$n|=2}
				if($my%10<=1) {$n|=1}
				if($mx%10==0||$my%10==0) {$n=3}
				$f="/images/aw/$n.gif";
				$link=qq!<a href="?xs=$mx&ys=$my&xe=$options{xe}&ye=$options{ye}">!;
			} else {
				$f="?x=$mx&y=$my";
				$link=qq!<a href="system-info?mapx=$mx&mapy=$my">!;}
			print qq!<td>$link<img src="$f">$linkend</td>!;

		}
		print "</tr>\n";
	}
	print "</table>";
} else {
	my ($dx,$dy);
	if($ENV{REMOTE_USER} eq "af") { ($dx,$dy)=(46,-50) }
	else { ($dx,$dy)=(-42,19) }
	print start_form('get'), 
		textfield('xs',$dx), " x position (center)", br,
		textfield('ys',$dy), " y position (center)", p,
		textfield('xe',29), " width", br,
		textfield('ye',25), " height", br;
	print submit("query"), end_form();
}
print end_html;

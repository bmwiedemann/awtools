#!/usr/bin/perl -w
# safe 070204
use strict;
use CGI qw":standard";
my $title="trade partners [\U$ENV{REMOTE_USER}\E]";

use awstandard;
use awinput;
awinput_init();
use sort_table;

print AWheader($title);

my %options;

for my $p (qw'sort') {
   $options{$p}=param($p);
}
if(!defined $options{sort}){$options{sort}="8.-2";}



sub gettradepartners2($$) { my($maxta,$minad)=@_;
  my @result;
  my $adprice=$awinput::prices{pp};
  my $prod=awinput::getallproductionsm();
  foreach my $e (@$prod) {
    my ($pid,$prod,$ad,$pp,$bonus,$arti)=@$e;
    my $name=playerid2namem($pid);
    $ad+=$pp*$adprice;
    if($ad<$minad) {next}
    my $adplus=$ad+getartifactprice($arti);
    my $trades=awinput::playerid2trades($pid);
    if($trades>$maxta) {next}
    push(@result,[$name,$pid,$ad, $adplus, $prod*$bonus*$adprice, $trades]);
  }
  return @result;
}

#print "test";
my @tap=gettradepartners2(4, 000);
my @tap2;
foreach my $entry (@tap) {
   my ($name, $pid, $ad, $adplus, $prod, $partners)=@$entry;
   if(!$pid || !$prod) {next}
   my @rel=getrelation($name);
   my $time=(20000-$ad)/$prod;
   my $timeplus=(20000-$adplus)/$prod;
   my ($race)=playerid2ir($pid);
   if($race && @$race && $race->[-2]) {$time=0; $timeplus=0} # TODO retest
#   push(@$entry, sprintf("%.2f",$time), $pid, $rel[0]);
   push(@tap2, [$pid, $rel[0], $ad, $prod, $partners, $time, $adplus, $timeplus]);
}

print sort_table([qw(who relation A$ prod/h partners ready(h) A$+arti ready+arti)], 
         [\&display_pid, \&display_relation, \&display_round0, \&display_round0, \&display_string, \&display_round1, \&display_round0, \&display_round1],
         [\&sort_pid, \&sort_num, \&sort_num, \&sort_num, \&sort_num, \&sort_num, \&sort_num, \&sort_num],
         sort_param_to_keys($options{sort}), \@tap2 );

print AWtail();
